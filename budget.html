<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Colorful Budget — Personal</title>
<meta name="description" content="Personal budgeting web app (local only). Add income, expenses, categories, see monthly summaries." />
<style>
  :root{
    --bg: #0f1724;
    --card: #0b1220;
    --muted: #98a0b3;
    --glass: rgba(255,255,255,0.04);
    --accent1: linear-gradient(135deg,#ff7ab6,#ffd36b);
    --accent2: linear-gradient(135deg,#7be1ff,#8b7bff);
    --accent3: linear-gradient(135deg,#7bf3a8,#4ee0d6);
    --radius: 14px;
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color-scheme: dark;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%, #081124 40%); color:#e6eef8}
  .app{
    max-width:980px;margin:20px auto;padding:18px;
    display:grid;grid-template-columns:360px 1fr;gap:18px;
  }
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{font-size:20px;margin:0;letter-spacing:0.2px}
  .subtitle{color:var(--muted);font-size:13px}
  .left, .right{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 6px 24px rgba(2,6,23,0.6);}
  /* balance card */
  .balance{
    background:linear-gradient(120deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:12px;padding:14px;margin-bottom:12px;
  }
  .balance .big{font-size:28px;font-weight:700}
  .balance .small{color:var(--muted);font-size:13px}
  /* form */
  form{display:grid;gap:8px}
  .row{display:flex;gap:8px}
  input[type="text"], input[type="number"], select, input[type="date"]{
    background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;color:inherit;font-size:14px;
  }
  button{background:transparent;border:0;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn-primary{background:linear-gradient(90deg,#ff7ab6,#8b7bff);color:#041125}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
  .btn-danger{background:linear-gradient(90deg,#ff7a7a,#ffb27a);color:#041125}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  /* history */
  .history{margin-top:14px;max-height:380px;overflow:auto}
  .txn{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
  .txn .left{display:flex;align-items:center;gap:10px}
  .dot{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#051023}
  .txndata{min-width:0}
  .txndata .title{font-weight:600}
  .txndata .meta{font-size:12px;color:var(--muted)}
  .amount{font-weight:700}
  .amount.income{color:#8ef3b6}
  .amount.expense{color:#ffb3b3}
  /* categories list */
  .category-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .category-pill{padding:6px 8px;border-radius:999px;font-size:13px;display:inline-flex;gap:8px;align-items:center}
  .small-card{padding:10px;border-radius:12px}
  /* summary chart */
  .summary{margin-top:12px}
  canvas{width:100%;height:160px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
  footer{grid-column:1/-1;margin-top:6px;color:var(--muted);font-size:12px;text-align:center}
  /* responsive */
  @media(max-width:920px){
    .app{grid-template-columns:1fr; padding:12px}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div>
      <h1>Colorful Budget</h1>
      <div class="subtitle">Personal • Local-only • Save to Home Screen</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="subtitle" id="current-month-label">Month: —</div>
      <select id="month-filter" aria-label="Choose month"></select>
      <button id="export-btn" class="btn-ghost">Export</button>
      <button id="import-btn" class="btn-ghost">Import</button>
    </div>
  </header>

  <!-- LEFT COLUMN -->
  <section class="left">
    <div class="balance">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Running balance</div>
          <div class="big" id="running-balance">$0.00</div>
        </div>
        <div style="text-align:right">
          <div class="small">This month</div>
          <div id="month-total" style="font-weight:700">+$0.00</div>
        </div>
      </div>
    </div>

    <div class="small-card">
      <form id="add-form" autocomplete="off">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <select id="type" aria-label="type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
          <input id="amount" type="number" min="0" step="0.01" placeholder="Amount" required />
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <select id="category-select" style="flex:1"></select>
          <input id="date" type="date" />
        </div>
        <input id="note" type="text" placeholder="Note (optional)" />
        <div class="controls" style="margin-top:8px">
          <button type="submit" class="btn-primary">Add</button>
          <button type="button" id="clear-form" class="btn-ghost">Clear</button>
          <button type="button" id="reset-all" class="btn-danger">Reset</button>
        </div>
      </form>
    </div>

    <div style="margin-top:12px" class="small-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Categories</div>
        <button id="new-cat-btn" class="btn-ghost">New</button>
      </div>
      <div class="category-list" id="category-list"></div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px">
        Click a category to set as selected for the form.
      </div>
    </div>

  </section>

  <!-- RIGHT COLUMN -->
  <section class="right">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
      <div style="flex:1">
        <div style="display:flex;gap:8px;align-items:center">
          <div style="font-weight:700">History</div>
          <div style="color:var(--muted);font-size:13px">— recent transactions</div>
        </div>
        <div class="history" id="history"></div>
      </div>

      <div style="width:320px">
        <div style="font-weight:700">Monthly Summary</div>
        <div class="summary small-card" id="summary-card">
          <canvas id="summary-canvas" width="600" height="240"></canvas>
          <div id="summary-list" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </section>

  <footer>
    Stored locally in your browser. Export/Import available. Tip: Add to Home Screen for app-like use.
  </footer>
</div>

<!-- hidden file input for import -->
<input type="file" id="import-file" accept=".json" style="display:none" />

<script>
/* =========================
   Data Model + Storage
   ========================= */
const STORAGE_KEY = 'colorful_budget_v1';

let state = {
  transactions: [], // {id, type, amountCents, categoryId, dateISO, note}
  categories: []    // {id, name, color}
};

// helper to generate id
const uid = (n=6) => Math.random().toString(36).slice(2,2+n);

// default categories
const DEFAULT_CATEGORIES = [
  {id:'c_food', name:'Food', color:'#ffb27a'},
  {id:'c_rent', name:'Rent', color:'#ffd36b'},
  {id:'c_transport', name:'Transport', color:'#7be1ff'},
  {id:'c_shopping', name:'Shopping', color:'#ff7ab6'},
  {id:'c_salary', name:'Salary', color:'#7bf3a8'},
  {id:'c_misc', name:'Misc', color:'#bda0ff'}
];

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      // simple migration guard
      state = {
        transactions: parsed.transactions || [],
        categories: parsed.categories || DEFAULT_CATEGORIES.slice()
      };
    } else {
      state = {transactions: [], categories: DEFAULT_CATEGORIES.slice()};
      saveState();
    }
  }catch(e){
    console.error('load error',e);
    state = {transactions: [], categories: DEFAULT_CATEGORIES.slice()};
  }
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* =========================
   Utilities
   ========================= */

// convert user amount (string) -> cents integer (avoid fp quirks)
function amountToCents(amountStr){
  const n = Number(String(amountStr).replace(/[^0-9.-]+/g,''));
  if(Number.isNaN(n)) return 0;
  // round to cents
  return Math.round(n * 100);
}
function centsToDisplay(cents){
  const sign = cents < 0 ? '-' : '';
  const abs = Math.abs(cents);
  const dollars = Math.floor(abs / 100);
  const centsPart = Math.abs(abs % 100).toString().padStart(2,'0');
  return `${sign}$${dollars}.${centsPart}`;
}
function dayISO(date){
  // return YYYY-MM-DD
  const d = new Date(date);
  if(isNaN(d)) return new Date().toISOString().slice(0,10);
  return d.toISOString().slice(0,10);
}

/* =========================
   Rendering
   ========================= */

const els = {
  runningBalance: document.getElementById('running-balance'),
  monthTotal: document.getElementById('month-total'),
  history: document.getElementById('history'),
  categoryList: document.getElementById('category-list'),
  categorySelect: document.getElementById('category-select'),
  monthFilter: document.getElementById('month-filter'),
  currentMonthLabel: document.getElementById('current-month-label'),
  summaryCanvas: document.getElementById('summary-canvas'),
  summaryList: document.getElementById('summary-list')
};

function renderCategories(){
  const wrap = els.categoryList; wrap.innerHTML = '';
  const select = els.categorySelect; select.innerHTML = '';
  state.categories.forEach(cat=>{
    // pill
    const pill = document.createElement('button');
    pill.className = 'category-pill';
    pill.style.background = cat.color;
    pill.textContent = cat.name;
    pill.onclick = ()=> {
      // set as selected in form
      select.value = cat.id;
      flashElement(select);
    };
    wrap.appendChild(pill);

    // select option
    const opt = document.createElement('option');
    opt.value = cat.id; opt.textContent = cat.name;
    select.appendChild(opt);
  });
  // add manage option
  const opt = document.createElement('option');
  opt.value = '__manage__';
  opt.textContent = 'Manage categories...';
  select.appendChild(opt);
}

/* small UI flash */
function flashElement(el){
  const original = el.style.transition || '';
  el.style.transition = 'transform 0.12s';
  el.style.transform = 'scale(1.04)';
  setTimeout(()=>{ el.style.transform=''; el.style.transition = original; },120);
}

function renderBalanceAndMonth(){
  // running balance = sum(all income - expense)
  let runningCents = 0;
  state.transactions.forEach(t => {
    runningCents += (t.type === 'income' ? 1 : -1) * t.amountCents;
  });
  els.runningBalance.textContent = centsToDisplay(runningCents);

  // month filter: selected month or latest month if empty
  const months = getAvailableMonths();
  const filter = document.getElementById('month-filter');
  const selected = filter.value || months[0] || '';
  const selectedMonth = selected || months[0] || dayISO(new Date()).slice(0,7);
  els.currentMonthLabel.textContent = 'Month: ' + selectedMonth;

  // compute month total (income - expense for that month)
  let monthTotalCents = 0;
  state.transactions.forEach(t => {
    if(t.dateISO.slice(0,7) === selectedMonth){
      monthTotalCents += (t.type === 'income' ? 1 : -1) * t.amountCents;
    }
  });
  const signed = monthTotalCents >= 0 ? '+' + centsToDisplay(monthTotalCents) : centsToDisplay(monthTotalCents);
  els.monthTotal.textContent = signed;
}

function getAvailableMonths(){
  const set = new Set();
  state.transactions.forEach(t => {
    set.add(t.dateISO.slice(0,7)); // YYYY-MM
  });
  // sort descending
  return Array.from(set).sort((a,b)=> b.localeCompare(a));
}

function populateMonthFilter(){
  const months = getAvailableMonths();
  const sel = els.monthFilter;
  sel.innerHTML = '';
  // ensure current month present
  const current = dayISO(new Date()).slice(0,7);
  if(!months.includes(current)) months.unshift(current);
  months.forEach(m=>{
    const o = document.createElement('option'); o.value = m; o.textContent = m; sel.appendChild(o);
  });
  sel.value = months[0] || current;
}

function renderHistory(){
  const container = els.history; container.innerHTML = '';
  // show most recent first
  const sorted = state.transactions.slice().sort((a,b)=> b.dateISO.localeCompare(a.dateISO) || b.id.localeCompare(a.id));
  sorted.forEach(tx=>{
    const div = document.createElement('div'); div.className = 'txn';
    const left = document.createElement('div'); left.className = 'left';
    const dot = document.createElement('div'); dot.className='dot';
    // find category color
    const cat = state.categories.find(c=>c.id===tx.categoryId) || {name:'', color:'#bbbbbb'};
    dot.style.background = cat.color;
    dot.textContent = cat.name ? cat.name.slice(0,2).toUpperCase() : '??';
    const data = document.createElement('div'); data.className='txndata';
    const title = document.createElement('div'); title.className='title';
    title.textContent = (tx.note && tx.note.length>0) ? tx.note : (cat.name || 'Transaction');
    const meta = document.createElement('div'); meta.className='meta';
    meta.textContent = `${cat.name || 'Uncat'} • ${tx.dateISO}`;
    data.appendChild(title); data.appendChild(meta);
    left.appendChild(dot); left.appendChild(data);

    const right = document.createElement('div'); right.style.textAlign='right';
    const amt = document.createElement('div'); amt.className='amount ' + (tx.type==='income'?'income':'expense');
    const signed = (tx.type==='income'? '+' : '-') + centsToDisplay(tx.amountCents).replace('-','');
    amt.textContent = signed;
    const actions = document.createElement('div'); actions.style.marginTop='6px';
    const editBtn = document.createElement('button'); editBtn.className='btn-ghost'; editBtn.textContent='Edit';
    editBtn.onclick = ()=> openEdit(tx.id);
    const delBtn = document.createElement('button'); delBtn.className='btn-ghost'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> { if(confirm('Delete this transaction?')) { deleteTransaction(tx.id); } };
    actions.appendChild(editBtn); actions.appendChild(delBtn);
    right.appendChild(amt); right.appendChild(actions);

    div.appendChild(left); div.appendChild(right);
    container.appendChild(div);
  });

  renderBalanceAndMonth();
}

/* =========================
   Transactions
   ========================= */

function addTransaction({type, amountCents, categoryId, dateISO, note}){
  const tx = { id: uid(8), type, amountCents, categoryId, dateISO, note };
  state.transactions.push(tx);
  saveState();
  refreshUI();
}

function updateTransaction(id, patch){
  const idx = state.transactions.findIndex(t=>t.id===id);
  if(idx>=0){
    state.transactions[idx] = {...state.transactions[idx], ...patch};
    saveState();
    refreshUI();
  }
}

function deleteTransaction(id){
  state.transactions = state.transactions.filter(t=>t.id!==id);
  saveState();
  refreshUI();
}

function openEdit(id){
  const tx = state.transactions.find(t=>t.id===id);
  if(!tx) return;
  // prefill form and change Add button to Save temporarily
  document.getElementById('type').value = tx.type;
  document.getElementById('amount').value = (tx.amountCents/100).toFixed(2);
  document.getElementById('category-select').value = tx.categoryId || '';
  document.getElementById('date').value = tx.dateISO;
  document.getElementById('note').value = tx.note || '';

  const form = document.getElementById('add-form');
  const submitBtn = form.querySelector('.btn-primary');
  submitBtn.textContent = 'Save';
  submitBtn.dataset.editing = id;
  flashElement(submitBtn);
}

/* =========================
   Categories
   ========================= */

function createCategory(name, color){
  const cat = { id: 'c_' + uid(6), name: name || 'New', color: color || randomColor() };
  state.categories.push(cat);
  saveState();
  renderCategories();
  refreshUI();
  return cat;
}

function randomColor(){
  const palette = ['#ffb27a','#ffd36b','#7be1ff','#ff7ab6','#7bf3a8','#bda0ff','#ffd6e0','#c2f0ff','#ffd9b8'];
  return palette[Math.floor(Math.random() * palette.length)];
}

/* =========================
   Summary (chart)
   ========================= */

function computeSummaryForMonth(yyyymm){
  // totals per category (expense positive numbers but we'll show absolute)
  const sums = {}; // id -> cents
  state.categories.forEach(c => sums[c.id] = 0);
  state.transactions.forEach(t => {
    if(t.dateISO.slice(0,7) === yyyymm){
      const sign = t.type === 'income' ? 1 : -1;
      sums[t.categoryId] = (sums[t.categoryId] || 0) + sign * t.amountCents;
    }
  });
  return sums;
}

function renderSummary(){
  const month = document.getElementById('month-filter').value || dayISO(new Date()).slice(0,7);
  const sums = computeSummaryForMonth(month);
  // build list
  const listWrap = els.summaryList; listWrap.innerHTML = '';
  // convert to array and sort by absolute value desc
  const arr = Object.keys(sums).map(id => {
    const cat = state.categories.find(c=>c.id===id) || {name:'Unknown', color:'#999'};
    return {id, name:cat.name, color: cat.color, cents: sums[id] || 0};
  }).sort((a,b)=> Math.abs(b.cents) - Math.abs(a.cents));

  // canvas bar chart
  const canvas = els.summaryCanvas;
  const ctx = canvas.getContext('2d');
  // clear
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // draw bars
  const pad = 12;
  const w = canvas.width - pad * 2;
  const h = canvas.height - pad * 2;
  const max = Math.max(...arr.map(a=>Math.abs(a.cents)), 100);
  const barH = Math.max(12, Math.floor(h / Math.max(1, arr.length)));
  let y = pad;
  arr.forEach((a, i) => {
    const val = a.cents;
    const width = Math.floor((Math.abs(val) / max) * w);
    // draw background bar
    ctx.fillStyle = a.color || '#888';
    // rounded bar by drawing rect with radius
    roundRect(ctx, pad, y+2, width, barH-8, 6, true, false);
    // text
    ctx.fillStyle = '#061126';
    ctx.font = '600 12px system-ui, -apple-system';
    const label = a.name;
    ctx.fillText(label, pad+6, y + (barH/2) + 4);
    // amount text right
    ctx.fillStyle = '#e6eef8';
    ctx.font = '600 12px system-ui, -apple-system';
    ctx.textAlign = 'right';
    ctx.fillText((a.cents >= 0 ? '+' : '-') + centsToDisplay(Math.abs(a.cents)).replace('$',''), pad + width - 8, y + (barH/2) + 4);
    ctx.textAlign = 'left';
    y += barH;
  });

  // below list with totals
  if(arr.length === 0){
    listWrap.innerHTML = '<div style="color:var(--muted)">No transactions this month.</div>';
  } else {
    arr.forEach(a=>{
      const row = document.createElement('div');
      row.style.display='flex';row.style.justifyContent='space-between';row.style.alignItems='center';row.style.marginTop='6px';
      const left = document.createElement('div'); left.style.display='flex';left.style.alignItems='center';left.style.gap='8px';
      const dot = document.createElement('div'); dot.style.width='12px';dot.style.height='12px';dot.style.borderRadius='3px';dot.style.background=a.color;
      const name = document.createElement('div'); name.textContent = a.name; name.style.fontWeight='600';
      left.appendChild(dot); left.appendChild(name);
      const right = document.createElement('div'); right.textContent = (a.cents >= 0 ? '+' : '-') + centsToDisplay(Math.abs(a.cents)).replace('$','');
      row.appendChild(left); row.appendChild(right);
      listWrap.appendChild(row);
    });
  }
}

/* draw rounded rect helper */
function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
  if (typeof stroke == 'undefined') {
    stroke = true;
  }
  if (typeof radius === 'undefined') {
    radius = 5;
  }
  if (typeof radius === 'number') {
    radius = {tl: radius, tr: radius, br: radius, bl: radius};
  } else {
    const defaultRadius = {tl: 0, tr: 0, br: 0, bl: 0};
    for (const side in defaultRadius) {
      radius[side] = radius[side] || defaultRadius[side];
    }
  }
  ctx.beginPath();
  ctx.moveTo(x + radius.tl, y);
  ctx.lineTo(x + width - radius.tr, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
  ctx.lineTo(x + width, y + height - radius.br);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
  ctx.lineTo(x + radius.bl, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
  ctx.lineTo(x, y + radius.tl);
  ctx.quadraticCurveTo(x, y, x + radius.tl, y);
  ctx.closePath();
  if (fill) {
    ctx.fill();
  }
  if (stroke) {
    ctx.stroke();
  }
}

/* =========================
   UI Wiring
   ========================= */

function refreshUI(){
  renderCategories();
  populateMonthFilter();
  renderHistory();
  renderSummary();
}

document.getElementById('add-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const submitBtn = e.target.querySelector('.btn-primary');
  const editingId = submitBtn.dataset.editing;
  const type = document.getElementById('type').value;
  const amountCents = amountToCents(document.getElementById('amount').value);
  const categoryId = document.getElementById('category-select').value;
  const dateISO = dayISO(document.getElementById('date').value || new Date());
  const note = document.getElementById('note').value.trim();
  if(categoryId === '__manage__'){
    openCategoryDialog();
    return;
  }
  if(amountCents <= 0){
    alert('Enter a positive amount.');
    return;
  }
  if(editingId){
    updateTransaction(editingId, {type, amountCents, categoryId, dateISO, note});
    submitBtn.textContent = 'Add'; delete submitBtn.dataset.editing;
  } else {
    addTransaction({type, amountCents, categoryId, dateISO, note});
  }
  e.target.reset();
});

document.getElementById('clear-form').addEventListener('click', ()=> {
  document.getElementById('add-form').reset();
});

document.getElementById('reset-all').addEventListener('click', ()=>{
  if(confirm('Reset all data? This will delete all transactions and categories (except defaults).')){
    state.transactions = [];
    state.categories = DEFAULT_CATEGORIES.slice();
    saveState();
    refreshUI();
  }
});

document.getElementById('new-cat-btn').addEventListener('click', openCategoryDialog);

function openCategoryDialog(){
  const name = prompt('Category name:');
  if(!name) return;
  const color = prompt('Hex color (e.g. #ffd36b) or leave blank for random:') || randomColor();
  createCategory(name, color);
}

/* month filter change */
document.getElementById('month-filter').addEventListener('change', ()=>{
  renderBalanceAndMonth();
  renderSummary();
});

/* export / import */
document.getElementById('export-btn').addEventListener('click', ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'budget_backup.json'; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
});

document.getElementById('import-btn').addEventListener('click', ()=>{
  document.getElementById('import-file').click();
});
document.getElementById('import-file').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = (ev)=>{
    try{
      const parsed = JSON.parse(ev.target.result);
      if(!confirm('Importing will overwrite local data. Continue?')) return;
      state = {
        transactions: parsed.transactions || [],
        categories: parsed.categories || DEFAULT_CATEGORIES.slice()
      };
      saveState(); refreshUI();
      alert('Import successful.');
    }catch(err){
      alert('Invalid file.');
    }
  };
  r.readAsText(f);
  e.target.value = '';
});

/* handle category select "manage" option */
document.getElementById('category-select').addEventListener('change', (e)=>{
  if(e.target.value === '__manage__'){
    openCategoryDialog();
    e.target.value = state.categories[0] ? state.categories[0].id : '';
  }
});

/* =========================
   Init
   ========================= */
loadState();
refreshUI();

/* =========================
   PWA manifest + Service Worker (attempt)
   Note: iOS Safari requires HTTPS for service worker to work.
   But manifest + "Add to Home Screen" still helps the icon/nicer experience.
   ========================= */

(async function registerPWA(){
  try{
    // manifest
    const manifest = {
      name: 'Colorful Budget (Local)',
      short_name: 'Budget',
      start_url: '.',
      display: 'standalone',
      background_color: '#071026',
      theme_color: '#081124',
      icons: [
        { src: 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect rx="90" width="100%" height="100%" fill="%23ff7ab6"/><text x="50%" y="55%" font-size="220" font-family="system-ui" text-anchor="middle" fill="%23041025">B</text></svg>'),
          sizes: '512x512', type: 'image/svg+xml' }
      ]
    };
    const mfBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const mfUrl = URL.createObjectURL(mfBlob);
    let link = document.querySelector('link[rel="manifest"]');
    if(!link){
      link = document.createElement('link'); link.rel='manifest';
      document.head.appendChild(link);
    }
    link.href = mfUrl;

    // service worker script (very small; caches the app shell)
    if('serviceWorker' in navigator){
      const swCode = `
        const CACHE = 'colorful-budget-shell-v1';
        const urlsToCache = ['.'];
        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE).then(cache => cache.addAll(urlsToCache)).catch(()=>{})
          );
          self.skipWaiting();
        });
        self.addEventListener('activate', event => {
          event.waitUntil(self.clients.claim());
        });
        self.addEventListener('fetch', event => {
          // Try network first, fallback to cache
          event.respondWith(
            fetch(event.request).catch(()=>caches.match(event.request))
          );
        });
      `;
      const swBlob = new Blob([swCode], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(swBlob);
      try{
        await navigator.serviceWorker.register(swUrl);
        console.log('Service worker registered (blob).');
      }catch(err){
        console.warn('Service worker registration failed:', err);
      }
    }
  }catch(err){
    console.warn('PWA setup skipped', err);
  }
})();

/* =========================
   Helpful small UI bit: export/import via copy/paste (also available)
   ========================= */
(function addKeyboardShortcuts(){
  window.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key === 'e'){ document.getElementById('export-btn').click(); }
    if(e.ctrlKey && e.key === 'i'){ document.getElementById('import-btn').click(); }
  });
})();

</script>
</body>
</html>
